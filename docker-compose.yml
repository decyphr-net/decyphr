version: "3"
services:
  mariadb:
    image: mariadb:latest
    env_file:
      - ./docker/env/mariadb.env
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
  redis:
    image: redis:7.2-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    env_file:
      - ./docker/env/zookeeper.env
    ports:
      - '2181:2181'
  kafka:
    image: confluentinc/cp-kafka:7.9.0
    depends_on:
      - zookeeper
    ports:
      - 9092:9092
      - 9093:9093
      - "29092:29092"
    env_file:
      - ./docker/env/kafka.env

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    depends_on:
      - kafka
    ports:
      - "9095:8080"
    env_file:
      - ./docker/env/kafka-ui.env

  translator:
    build:
      context: ./apps/translation/translation-connector
      dockerfile: ./Dockerfile
    ports:
      - "3009:3009"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/translation/translation-connector/.env

  ai-connector:
    build:
      context: ./apps/ai/ai-connector
      dockerfile: ./Dockerfile
    ports:
      - "8006:3000"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/ai/ai-connector/.env
  bots:
    build:
      context: ./apps/chat/bots
      dockerfile: ./Dockerfile
    ports:
      - "8007:3000"
    restart: always
    depends_on:
      - mariadb
      - redis
    env_file:
      - ./apps/chat/bots/.env
  chat:
    build:
      context: ./apps/chat/chat
      dockerfile: ./Dockerfile
    ports:
      - "3008:3008"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/chat/chat/.env
  nlp:
    build:
      context: ./nlp
    container_name: nlp
    ports:
      - "8300:8300"
    restart: unless-stopped
  lexicon:
    build:
      context: ./apps/lexicon
      dockerfile: ./Dockerfile
    ports:
      - "3010:3010"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/lexicon/.env
  phrasebook:
    build:
      context: .
      dockerfile: ./apps/phrasebook/Dockerfile
    ports:
      - "3011:3011"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/phrasebook/.env

  flashcards:
    build:
      context: .
      dockerfile: ./apps/flashcards/Dockerfile
    ports:
      - "3012:3012"
    restart: always
    depends_on:
      - kafka
      - mariadb
    env_file:
      - ./apps/flashcards/.env

  focus:
    build:
      context: .
      dockerfile: ./apps/focus/Dockerfile
    expose:
      - "3013"
    restart: always
    depends_on:
      - mariadb
    env_file:
      - ./apps/focus/.env

  practice:
    build:
      context: .
      dockerfile: ./apps/practice/Dockerfile
    expose:
      - "3014"
    restart: always
    depends_on:
      - mariadb
      - kafka
      - phrasebook
    env_file:
      - ./apps/practice/.env

  courses:
    build:
      context: .
      dockerfile: ./apps/courses/Dockerfile
    expose:
      - "3015"
    restart: always
    depends_on:
      - mariadb
      - kafka
    env_file:
      - ./apps/courses/.env

  challenges:
    build:
      context: .
      dockerfile: ./apps/challenges/Dockerfile
    expose:
      - "3016"
    restart: always
    depends_on:
      - mariadb
      - courses
    env_file:
      - ./apps/challenges/.env

  client:
    build:
      context: ./apps/client
      dockerfile: ./Dockerfile
    ports:
      - "8000:8000"
    restart: always
    depends_on:
      - mariadb
      - kafka
      - flashcards
      - focus
      - practice
      - courses
      - challenges
    env_file:
      - ./apps/client/.env
      - ./docker/env/client.env

  web:
    build:
      context: ./apps/web
      dockerfile: ./Dockerfile
    ports:
      - "5173:5173"
    restart: always
    depends_on:
      - client
    env_file:
      - ./docker/env/web.env

volumes:
  mariadb_data:
  redis_data:

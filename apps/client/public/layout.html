<!doctype html>
<html lang="en" hx-boost="true">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Misneach</title>
  <script src="https://unpkg.com/htmx.org"></script>
  <script src="/scripts/auth/first-login.js" defer></script>
  <script src="/scripts/dashboard/chat.js" defer></script>
  <script src="/scripts/dashboard/translations.js" defer></script>
  <script src="/scripts/dashboard/lexicon.js" defer></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/@sjmc11/tourguidejs/dist/tour.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/franken-ui@2.0.0/dist/css/core.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/@sjmc11/tourguidejs/dist/css/tour.min.css" />
  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>
  <style>
    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slide-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes zoom-in {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-fade-in {
      animation: fade-in 1s ease-in-out forwards;
    }

    .animate-slide-in {
      animation: slide-in 1s ease-out forwards;
    }

    .animate-fade-in-delay {
      animation: fade-in 1s ease-in-out 0.5s forwards;
    }

    .animate-zoom-in {
      animation: zoom-in 0.6s ease-out forwards;
    }

    .delay-0 {
      animation-delay: 0s;
    }

    .delay-100 {
      animation-delay: 0.1s;
    }

    .delay-200 {
      animation-delay: 0.2s;
    }

    .delay-300 {
      animation-delay: 0.3s;
    }

    aside {
      overflow: visible;
    }
  </style>
</head>

<body x-data>
  <!-- Shared Navigation -->
  <div class="relative flex min-h-screen" x-data="dashboardSidebar()" x-init="init()"
    @keydown.window.ctrl.b.prevent="toggle()">
    <aside
      class="fixed inset-y-0 left-0 z-50 bg-gradient-to-b from-teal-500 via-blue-500 to-indigo-600 text-white flex flex-col transition-transform duration-200 ease-out border-0"
      :class="{
            'w-64 md:w-64' : !isMobile(),
            'w-full h-full' : isMobile(),
            '-translate-x-full' : !sidebarOpen,
            'translate-x-0'    : sidebarOpen
          }">
      <!-- Header (title + mobile close button) -->
      <div class="flex items-center justify-between p-4 border-b border-white/10">
        <!-- Mobile close (√ó) button ‚Äì only visible on mobile when open -->
        <button @click="sidebarOpen = false" class="md:hidden p-2 rounded hover:bg-white/10 transition"
          x-show="isMobile() && sidebarOpen" aria-label="Close sidebar">
          <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- ------------------------------------------------------------
               Navigation links ‚Äì keep them simple; they automatically
               hide/show the label based on `sidebarOpen`
               ------------------------------------------------------------ -->
      <nav class="flex-1 overflow-y-auto px-2 py-4 space-y-4">
        <template x-for="section in navSections" :key="section.title">
          <div>
            <div class="px-3 text-xs uppercase tracking-wide text-white/50 mb-1" x-show="sidebarOpen"
              x-text="section.title"></div>

            <template x-for="item in section.items" :key="item.id">
              <a :href="item.href" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition"
                :class="sidebarOpen ? 'justify-start' : 'justify-center'">
                <i :data-lucide="item.icon" class="w-5 h-5"></i>
                <span x-show="sidebarOpen" x-text="item.label"></span>
              </a>
            </template>
          </div>
        </template>
      </nav>

      <div x-show="$store.auth?.user?.user" class="px-3 py-4 border-t border-white/20">
        <div class="flex items-center gap-3 rounded-lg px-3 py-2 bg-white/10 hover:bg-white/15 transition"
          :class="sidebarOpen ? 'justify-start' : 'justify-center'">
          <div class="flex items-center justify-center w-8 h-8 rounded-full bg-white/20">
            <i data-lucide="user" class="w-4 h-4 text-white"></i>
          </div>
          <div x-show="sidebarOpen" x-transition.opacity.duration.200ms class="min-w-0">
            <p class="text-xs font-medium text-white/80 truncate" x-text="$store.auth.user.user.email"></p>
          </div>
        </div>
      </div>

      <!-- ====================  LANGUAGE DROPDOWN  ==================== -->
      <div class="px-3 py-4 border-t border-white/20">
        <div x-data class="relative">
          <!-- Trigger button -->
          <button @click="toggleLangMenu()" x-ref="langBtn"
            class="flex items-center gap-2 w-full px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition justify-between"
            :class="sidebarOpen ? 'justify-start' : 'justify-center'">
            <div class="flex items-center gap-2">
              <i data-lucide="globe" class="w-4 h-4 text-white"></i>
              <span x-show="sidebarOpen" x-transition.opacity.duration-200ms>Language</span>
            </div>
            <svg class="w-4 h-4 text-white transition-transform" :class="{ 'rotate-180': langMenuOpen }" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown list -->
          <ul x-show="langMenuOpen" @click.away="closeLangMenu()"
            class="absolute left-0 w-48 bg-white rounded-md shadow-lg max-h-56 overflow-y-auto z-10 border border-gray-200 text-gray-800"
            :class="langMenuFlipUp ? 'bottom-full mb-2' : 'top-full mt-1'">
            <template x-for="([code, name]) in Object.entries($store.i18n.languageNames)" :key="code">
              <li @click="chooseLanguage(code)" class="flex items-center px-4 py-2 cursor-pointer hover:bg-gray-100">
                <span class="mr-2" x-text="$store.i18n.languageFlags[code]"></span>
                <span x-text="name"></span>
                <svg class="ml-auto w-4 h-4 text-teal-600" x-show="selectedLang===code" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
              </li>
            </template>
          </ul>
        </div>
      </div>

      <!-- ------------------------------------------------------------
               Logout button (optional)
               ------------------------------------------------------------ -->
      <div x-show="$store.auth.isLoggedIn" class="px-3 py-4 border-t border-white/20">
        <button @click="logout()"
          class="flex items-center gap-2 w-full px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition"
          :class="sidebarOpen ? 'justify-start' : 'justify-center'">
          <i data-lucide="log-out" class="w-4 h-4 text-white"></i>
          <span x-show="sidebarOpen" x-transition.opacity.duration.200ms>Log out</span>
        </button>
      </div>
    </aside>

    <div x-show="sidebarOpen && isMobile()" @click="sidebarOpen = false"
      class="fixed inset-0 bg-black/40 z-40 transition-opacity duration-200" aria-hidden="true"></div>

    <!-- ------------------------------------------------------------
             Hamburger ‚Äì hidden when the full‚Äëscreen sidebar is open on mobile
             ------------------------------------------------------------ -->
    <button @click="toggleSidebar()" x-show="!sidebarOpen || !isMobile()"
      class="fixed top-4 left-4 z-50 p-2 rounded bg-teal-600 text-white transition-opacity duration-200 focus:outline-none">
      <i data-lucide="menu"></i>
    </button>

    <!-- Main content -->
    <div class="flex flex-col flex-1 min-h-screen">
      <main id="content" hx-get="{{PARTIAL_ROUTE}}" hx-trigger="load" hx-swap="innerHTML" class="flex-1 min-w-0">
        Loading‚Ä¶
      </main>
    </div>
  </div>

  <footer class="bg-gray-800 text-gray-300 py-10 mt-8">
    <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-3 gap-8">
      <div>
        <h3 class="text-white text-xl font-semibold mb-4" x-text="$store.i18n.t('footer.about.title')"></h3>
        <p x-text="$store.i18n.t('footer.about.description')"></p>
      </div>
      <div>
        <h3 class="text-white text-xl font-semibold mb-4" x-text="$store.i18n.t('footer.links.title')"></h3>
        <ul class="space-y-2">
          <li>
            <a href="/auth/login" class="hover:text-white" x-text="$store.i18n.t('footer.links.login')"></a>
          </li>
          <li>
            <a href="#" class="hover:text-white" x-text="$store.i18n.t('footer.links.privacy')"></a>
          </li>
          <li>
            <a href="#" class="hover:text-white" x-text="$store.i18n.t('footer.links.terms')"></a>
          </li>
        </ul>
      </div>
      <div>
        <h3 class="text-white text-xl font-semibold mb-4" x-text="$store.i18n.t('footer.contact.title')"></h3>
        <p>Email: support@decyphr.com</p>
        <p>Twitter: @decyphrapp</p>
      </div>
    </div>
    <div class="mt-8 text-center text-gray-500 text-sm">
      ¬© 2025 Misneach. All rights reserved.
    </div>
  </footer>

  <script>
    document.body.addEventListener('htmx:afterSwap', (e) => {
      if (window.Alpine?.initTree) Alpine.initTree(e.target);
      if (window.lucide) {
        lucide.createIcons(e.target);
      }
    });

    document.body.addEventListener('htmx:historyRestore', (e) => {
      if (window.lucide) {
        e.target.querySelectorAll('[data-lucide]').forEach((el) => {
          el.dataset.lucideInit = 'true';
        });
        lucide.createIcons({ observe: false });
      }
    });

    document.body.addEventListener('htmx:historyRestore', (e) => {
      const sidebar = Alpine.store('sidebar');
      if (sidebar) {
        sidebar.hoverExpanded = false;
      }
    });

    document.addEventListener('alpine:init', () => {
      Alpine.data('authForm', () => ({
        email: '',
        loading: false,
        message: '',
        init() {
          const params = new URLSearchParams(window.location.search);
          const prefill = params.get('email');
          if (prefill) this.email = prefill;
        },
        async submit() {
          this.loading = true;
          this.message = '';
          try {
            const res = await fetch('/auth/magic-link', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: this.email }),
            });
            const data = await res.json();
            this.loading = false;
            if (res.ok)
              this.message =
                Alpine.store('i18n')?.t('auth.sent') || 'Magic link sent!';
            else
              this.message =
                data.error ||
                Alpine.store('i18n')?.t('auth.error') ||
                'Something went wrong';
          } catch (err) {
            console.error('Magic link error:', err);
            this.loading = false;
            this.message =
              Alpine.store('i18n')?.t('auth.error') || 'Something went wrong';
          }
        },
      }));
    });

    document.addEventListener('alpine:init', () => {
      Alpine.store('auth', {
        user: null,
        async init() {
          try {
            const res = await fetch('/auth/me', { credentials: 'include' });
            if (res.ok) this.user = await res.json();
          } catch (err) {
            console.warn('User not logged in or /api/me failed', err);
          }
        },
        get isLoggedIn() {
          return !!this.user;
        },
      });
      Alpine.store('auth').init();
    });

    function dashboardSidebar() {
      return {
        /* ---------- STATE ---------- */
        sidebarOpen: false, // true = sidebar visible (overlay on mobile)

        /* ---------- HELPERS ---------- */
        isMobile() {
          return window.innerWidth < 768;
        },

        /* ---------- TOGGLES ---------- */
        toggleSidebar() {
          this.sidebarOpen = !this.sidebarOpen;
          if (!this.isMobile()) {
            localStorage.setItem('sidebarOpen', this.sidebarOpen);
          }
        },
        toggle() {
          this.toggleSidebar();
        },

        langMenuOpen: false,
        langMenuFlipUp: false,
        // Currently selected language (read from the i18n store)
        selectedLang: null,

        // Called when the globe button is clicked
        toggleLangMenu() {
          this.langMenuOpen = !this.langMenuOpen;
          if (this.langMenuOpen) {
            // After the DOM updates, decide whether to open upward
            this.$nextTick(() => {
              const btn = this.$refs.langBtn;
              if (!btn) return;
              const rect = btn.getBoundingClientRect();
              const spaceBelow = window.innerHeight - rect.bottom;
              this.langMenuFlipUp = spaceBelow < 200; // <200‚ÄØpx ‚Üí flip up
            });
          }
        },

        /* close the menu when clicking outside */
        closeLangMenu() {
          this.langMenuOpen = false;
        },

        /* user selects a language */
        chooseLanguage(code) {
          this.$store.i18n.saveLanguage(code);
          this.selectedLang = code;
          this.langMenuOpen = false;
        },

        /* ---------- INIT ---------- */
        init() {
          const saved = localStorage.getItem('sidebarOpen');
          this.sidebarOpen = saved === 'true';
          this.$nextTick(() => {
            this.selectedLang = this.$store.i18n.language;
          });
        },

        /* ---------- NAVIGATION DATA ---------- */
        navSections: [
          {
            title: 'Speaking & Writing',
            items: [
              { id: 'chat', label: 'Chat', href: '/chat', icon: 'bot' },
            ],
          },
          {
            title: 'Vocabulary',
            items: [
              {
                id: 'lexicon',
                label: 'Lexicon',
                href: '/lexicon',
                icon: 'list',
              },
              {
                id: 'phrasebook',
                label: 'Phrasebook',
                href: '/lexicon/statements',
                icon: 'archive',
              },
            ],
          },
          {
            title: 'Tools',
            items: [
              {
                id: 'tools-translation',
                label: 'Translation Tool',
                href: '/translations',
                icon: 'languages',
              },
            ],
          },
        ],

        isActive(item) {
          const cur = window.location.pathname.replace(/\/+$/, '');
          const href = item.href.replace(/\/+$/, '');
          return cur === href;
        },

        async logout() {
          await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include',
          });
          Alpine.store('auth').user = null;
          window.location.href = '/auth/login';
        },
      };
    }
  </script>
  <script>
    Alpine.store('practice', {
      // -------------------  State -------------------
      timerRunning: false,
      elapsedSec: 0,
      paused: false,
      canAdvance: true, // you can tighten this later

      // Private timer ID (not exposed)
      _timerId: null,

      // -------------------  Public API -------------------
      /**
       * Start a practice session.
       * `info` should contain:
       *   {
       *     steps:          ['chat','translate','quiz'],
       *     currentIdx:     0,
       *     maxSecondsPerStep: 45   // optional, omit for untimed steps
       *   }
       */
      start(info) {
        this.timerRunning = !!info.maxSecondsPerStep;
        this.elapsedSec = 0;
        this.paused = false;
        this.canAdvance = true;
        // Store the meta data we need for UI (steps, currentIdx, timer)
        this.steps = info.steps || [];
        this.currentIdx = info.currentIdx || 0;
        this.maxSecondsPerStep = info.maxSecondsPerStep || null;
        this._startTimer(this.maxSecondsPerStep);
      },

      /** End the current session (finished or aborted) */
      stop() {
        this._stopTimer();
        this.timerRunning = false;
        this.elapsedSec = 0;
        this.paused = false;
        this.canAdvance = false;
        this.steps = [];
        this.currentIdx = 0;
        this.maxSecondsPerStep = null;
      },

      /** Pause / resume the timer */
      togglePause() {
        if (!this.timerRunning) return;
        this.paused = !this.paused;
        if (this.paused) this._stopTimer();
        else this._startTimer(this.maxSecondsPerStep);
      },

      /** Advance to the next step (user clicks ‚ÄúNext‚Äù) */
      next() {
        if (!this.canAdvance) return;
        this._stopTimer(); // stop current timer

        // -------------------------------------------------
        // Tell the back‚Äëend we want the next step.
        // Adjust the event name / payload to match your API.
        // -------------------------------------------------
        const socket = io('http://127.0.0.1:8000'); // same endpoint you already use
        socket.emit('practice-next', {
          // You may want to include a sessionId, currentIdx, etc.
          // For a generic example we just send an action flag:
          action: 'next',
          currentIdx: this.currentIdx,
        });

        // UI will be refreshed when the server sends back the new step
        // (see the socket listener further down).
      },

      // -------------------  Internal timer helpers -------------------
      _startTimer(maxSeconds) {
        if (!maxSeconds) return; // untimed step
        this._stopTimer(); // safety net
        this._timerId = setInterval(() => {
          if (this.paused) return;
          this.elapsedSec++;
          // Auto‚Äëadvance when the limit is reached (optional)
          if (this.elapsedSec >= maxSeconds) {
            this.next(); // move forward automatically
          }
        }, 1000);
      },

      _stopTimer() {
        clearInterval(this._timerId);
        this._timerId = null;
      },
    });

    /* ------------------------------------------------------------
3Ô∏è‚É£  Socket listener ‚Äì receives the next‚Äëstep payload
------------------------------------------------------------ */
    document.addEventListener('alpine:init', () => {
      const socket = io('http://127.0.0.1:8000');

      // Expected payload from the server:
      // {
      //   steps: ['chat','translate','quiz'],
      //   currentIdx: 1,
      //   maxSecondsPerStep: 30   // optional
      // }
      socket.off('practice-next');
      socket.on('practice-next', (data) => {
        const practice = Alpine.store('practice');

        // Replace the steps array if the server sent a new one
        if (Array.isArray(data.steps)) practice.steps = data.steps;

        // Update the current index (fallback to 0 if undefined)
        practice.currentIdx = data.currentIdx ?? 0;

        // Update timer for the new step
        if (data.maxSecondsPerStep) {
          practice.timerRunning = true;
          practice.maxSecondsPerStep = data.maxSecondsPerStep;
          practice._startTimer(data.maxSecondsPerStep);
        } else {
          practice.timerRunning = false;
          practice.maxSecondsPerStep = null;
          practice._stopTimer();
        }

        // Reset elapsed seconds and pause flag for the new step
        practice.elapsedSec = 0;
        practice.paused = false;
        practice.canAdvance = true;
      });
    });

    /* ------------------------------------------------------------
4Ô∏è‚É£  Helper API ‚Äì expose methods for any page component
------------------------------------------------------------ */
    window.practiceAPI = {
      /**
       * Call from any page component to start a session.
       * `info` must match the shape expected by the store.start():
       *   {
       *     steps: ['chat','translate','quiz'],
       *     currentIdx: 0,
       *     maxSecondsPerStep: 45   // optional
       *   }
       */
      startSession(info) {
        Alpine.store('practice').start(info);
      },

      /** Stop the current session */
      stopSession() {
        Alpine.store('practice').stop();
      },

      /** Toggle pause / resume */
      togglePause() {
        Alpine.store('practice').togglePause();
      },

      /** Advance to the next step */
      nextStep() {
        Alpine.store('practice').next();
      },
    };
  </script>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('i18n', {
        translations: {},
        languageNames: { en: 'English', ga: 'Gaeilge', pt: 'Portugu√™s' },
        languageFlags: { en: 'üá¨üáß', ga: 'üáÆüá™', pt: 'üáµüáπ' },

        t(key, vars = {}) {
          let str =
            key
              .split('.')
              .reduce((obj, part) => obj?.[part], this.translations) || key;
          // Simple {var} replacement
          Object.keys(vars).forEach((k) => {
            str = str.replace(new RegExp(`{${k}}`, 'g'), vars[k]);
          });
          return str;
        },

        /* -------------------------------------------------
Getter ‚Äì always reads the current value from localStorage
------------------------------------------------- */
        get language() {
          return localStorage.getItem('language') || 'en';
        },

        /* -------------------------------------------------
Persist a new language and reload the page
------------------------------------------------- */
        saveLanguage(lang) {
          localStorage.setItem('language', lang);
          this.loadTranslations(lang);
          location.reload();
        },

        loadTranslations(lang = localStorage.getItem('language') || 'en') {
          fetch(`/i18n?lang=${lang}`)
            .then((res) => res.json())
            .then((data) => {
              this.translations = data;
            });
          console.log(this.translations);
        },
      });
      Alpine.store('i18n').loadTranslations();
    });
  </script>
</body>

</html>